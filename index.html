<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì‹¤ì‹œê°„ í•™ì‚¬ë ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .day-cell { min-height: 110px; background-color: white; padding: 6px; }
        .event-item { font-size: 11px; padding: 3px 6px; margin-top: 3px; border-radius: 4px; background-color: #f1f5f9; border-left: 3px solid #6366f1; color: #1e293b; font-weight: 700; display: flex; justify-content: space-between; }
        .text-sun { color: #ef4444; } .text-sat { color: #3b82f6; }
        .del-x { color: #ef4444; cursor: pointer; margin-left: 4px; }
    </style>
    <script>
        // [ì„¤ì •]
        const API = 'https://script.google.com/macros/s/AKfycbwftofBuDxYKEkCF-5mZ4Ss-bi6VJVstCAR6RhKasmXeM6oF7ZuCwlcbpU7GzivVMyH/exec';
        let events = [];
        let now = new Date();
        let viewMode = 'monthly';

        // [í•¨ìˆ˜: ë‚ ì§œë¥¼ "YYYY-MM-DD" ê¸€ìë¡œ ë³€í™˜]
        window.getStrDate = (d) => {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        // [í•¨ìˆ˜: í™”ë©´ ê·¸ë¦¬ê¸°]
        window.render = function() {
            const port = document.getElementById('viewPort');
            const title = document.getElementById('titleText');
            if(!port) return;

            const y = now.getFullYear(), m = now.getMonth();
            title.innerText = `${y}ë…„ ${m + 1}ì›” ${viewMode === 'weekly' ? 'ì£¼ê°„' : ''}`;
            port.innerHTML = '';

            if (viewMode === 'monthly') {
                let html = '<div class="calendar-grid">';
                ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(w => html += `<div class="bg-slate-50 p-2 text-center text-[11px] font-bold text-slate-400">${w}</div>`);
                
                const first = new Date(y, m, 1).getDay();
                const last = new Date(y, m + 1, 0).getDate();

                for (let i = 0; i < first; i++) html += '<div class="day-cell bg-slate-50/30"></div>';
                for (let d = 1; d <= last; d++) {
                    const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayIdx = new Date(y, m, d).getDay();
                    const colorClass = dayIdx === 0 ? 'text-sun' : (dayIdx === 6 ? 'text-sat' : 'text-slate-400');

                    html += `<div class="day-cell">
                        <div class="text-[11px] font-black ${colorClass}">${d}</div>
                        <div class="mt-1">
                            ${events.filter(e => e.date === dateStr).map(e => `
                                <div class="event-item">
                                    <span>${e.title} (${e.dapt})</span>
                                    <span class="del-x" onclick="window.handleDelete('${e.id}')">âœ•</span>
                                </div>`).join('')}
                        </div>
                    </div>`;
                }
                port.innerHTML = html + '</div>';
            } else {
                // ì£¼ê°„ ëª¨ë“œ
                const start = new Date(now);
                start.setDate(now.getDate() - now.getDay());
                let html = '<div class="flex flex-col gap-2">';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    const dateStr = window.getStrDate(d);
                    html += `<div class="p-4 bg-white rounded-xl border flex items-center shadow-sm">
                        <div class="w-16 font-black text-indigo-900 border-r mr-4">${d.getDate()}ì¼</div>
                        <div class="flex-1">${events.filter(e => e.date === dateStr).map(e => `<div class="event-item mb-1 p-2"><span>${e.title} (${e.dapt})</span><span class="del-x" onclick="window.handleDelete('${e.id}')">âœ•</span></div>`).join('')}</div>
                    </div>`;
                }
                port.innerHTML = html + '</div>';
            }
        };

        window.move = (n) => {
            if (viewMode === 'monthly') now.setMonth(now.getMonth() + n);
            else now.setDate(now.getDate() + (n * 7));
            window.render();
        };

        window.toggleView = (v) => { viewMode = v; window.render(); };

        window.handleSave = async () => {
            const date = document.getElementById('inDate').value;
            const title = document.getElementById('inTitle').value;
            const dapt = document.getElementById('inDept').value;
            if (!date || !title) return alert("ë‚ ì§œì™€ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            
            const newItem = { id: String(Date.now()), date, title, dapt };
            events.push(newItem); window.render();
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'add', ...newItem }) });
        };

        window.handleDelete = async (id) => {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            events = events.filter(e => e.id !== id); window.render();
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
        };

        async function sync() {
            try {
                const res = await fetch(API);
                const data = await res.json();
                // ì„œë²„ ë‚ ì§œ ë°ì´í„°ì—ì„œ ì‹œì°¨ ë¬´ì‹œí•˜ê³  ê¸€ìë§Œ ì¶”ì¶œ
                events = data.map(e => ({ ...e, date: String(e.date).substring(0, 10) }));
                window.render();
            } catch (e) { console.error("Sync Fail", e); }
        }

        window.onload = () => { sync(); setInterval(sync, 15000); };
    </script>
</head>
<body class="p-3">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-indigo-900 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black">ğŸ« êµ¬ë¡€ì¤‘ í•™ì‚¬ë ¥</h1>
            <div class="flex gap-2">
                <button onclick="window.toggleView('monthly')" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="window.toggleView('weekly')" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ì£¼ê°„</button>
            </div>
        </header>

        <section class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm outline-none">
            <input type="text" id="inTitle" placeholder="í–‰ì‚¬ë‚´ìš©" class="border p-2 rounded-xl text-sm outline-none">
            <select id="inDept" class="border p-2 rounded-xl text-sm outline-none">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
            </select>
            <button onclick="window.handleSave()" class="bg-indigo-600 text-white rounded-xl font-bold py-2">ì €ì¥í•˜ê¸°</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="window.move(-1)" class="text-indigo-600 font-bold px-4">â®</button>
            <h2 id="titleText" class="text-lg font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="window.move(1)" class="text-indigo-600 font-bold px-4">â¯</button>
        </div>

        <div id="viewPort"></div>

        <footer class="text-center py-8 text-slate-400 text-[10px]">
            Â© Choi Gwang-cheul, Gurye Middle School
        </footer>
    </div>
</body>
</html>
