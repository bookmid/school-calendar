<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>êµ¬ë¡€ì¤‘ í•™ì‚¬ë ¥</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.notice-green{background:#d1fae5!important;border-color:#10b981!important;font-weight:700!important;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;}
.modal.show{display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body class="bg-gray-50 p-4">
<div class="max-w-5xl mx-auto">
<header class="bg-indigo-900 text-white p-4 rounded-xl mb-4 flex justify-between items-center">
<h1 class="text-xl font-bold">ğŸ« êµ¬ë¡€ì¤‘ í•™ì‚¬ë ¥</h1>
<div class="flex gap-2">
<button id="btnAdmin" class="bg-indigo-700 px-3 py-1 rounded text-sm">ğŸ”</button>
<button id="btnWeek" class="bg-indigo-700 px-3 py-1 rounded text-sm">ì£¼ê°„</button>
<button id="btnMonth" class="bg-indigo-700 px-3 py-1 rounded text-sm">ì›”ê°„</button>
<button id="btnYear" class="bg-indigo-700 px-3 py-1 rounded text-sm">í•™ì‚¬ë ¥</button>
</div>
</div>
</header>
<div class="bg-white p-4 rounded-xl mb-4 grid grid-cols-1 md:grid-cols-4 gap-2">
<input type="date" id="inDate" class="border p-2 rounded">
<input type="text" id="inTitle" placeholder="í–‰ì‚¬ë‚´ìš©" class="border p-2 rounded">
<select id="inDept" class="border p-2 rounded">
<option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
</select>
<button id="btnSave" class="bg-indigo-600 text-white rounded font-bold">ì €ì¥</button>
</div>
<div class="bg-white p-3 rounded-xl mb-4 flex justify-between items-center">
<button id="btnPrev" class="text-indigo-600 font-bold px-4">â®</button>
<h2 id="titleText" class="font-bold">2026ë…„ 2ì›” ì£¼ê°„</h2>
<button id="btnNext" class="text-indigo-600 font-bold px-4">â¯</button>
</div>
<div id="viewport" class="bg-white p-4 rounded-xl mb-4">ë¡œë”© ì¤‘...</div>
<div id="notices" class="bg-white p-4 rounded-xl mb-4" style="display:none;">
<h3 class="font-bold mb-4">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>
<div id="noticeList"></div>
</div>
<div id="adminBadge" style="display:none;position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:8px;border-radius:8px;z-index:1000;">ğŸ” ê´€ë¦¬ì</div>
<div id="sync" style="position:fixed;bottom:20px;right:20px;background:#4f46e5;color:white;padding:8px 16px;border-radius:20px;z-index:1000;font-size:12px;">â— ë¡œë”©</div>
</div>

<div id="loginModal" class="modal">
<div style="background:white;padding:24px;border-radius:16px;max-width:400px;width:90%;">
<h3 class="font-bold text-lg mb-4">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
<input type="text" id="adminId" value="admin" class="w-full border p-2 rounded mb-2">
<input type="password" id="adminPw" class="w-full border p-2 rounded mb-2">
<button id="btnLogin" class="w-full bg-indigo-600 text-white p-2 rounded font-bold">ë¡œê·¸ì¸</button>
</div>
</div>

<div id="detailModal" class="modal">
<div style="background:white;padding:24px;border-radius:16px;max-width:600px;width:90%;position:relative;">
<button id="closeDetail" style="position:absolute;top:12px;right:12px;font-size:24px;background:none;border:none;cursor:pointer;">&times;</button>
<div id="detailContent"></div>
</div>
</div>

<script>
var API="https://script.google.com/macros/s/AKfycbzBzEu_8Xo_EOIcFX48-Lj6k5TehW6gF86fX7zkQszp1qzCX3RsXKfeVCUezVzfnaCx/exec";
var events=[],notices={},currentDate=new Date(),viewMode="week",isAdmin=false,loading=false,saving=false;
var dayNames=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

function normalizeDate(dateStr){
if(!dateStr)return"";
var parts=String(dateStr).split(/[-\/\s]/);
if(parts.length>=3){
var y=parts[0];
var m=String(parseInt(parts[1])).padStart(2,"0");
var d=String(parseInt(parts[2])).padStart(2,"0");
return y+"-"+m+"-"+d;
}
return String(dateStr).substring(0,10);
}

function setSyncStatus(text,color){
var el=document.getElementById("sync");
el.textContent=text;
el.style.background=color||"#4f46e5";
}

function load(){
if(loading||saving)return;
loading=true;
setSyncStatus("â— ë¡œë”©...","#f59e0b");
console.log("ğŸ“¥ ë¡œë“œ ì‹œì‘");

fetch(API+"?action=load&t="+Date.now())
.then(function(r){
console.log("ğŸ“¥ ì‘ë‹µ:",r.status);
if(!r.ok)throw new Error("HTTP "+r.status);
return r.json();
})
.then(function(data){
console.log("âœ… ì›ë³¸ ë°ì´í„°:",data);

events=(data.events||[]).map(function(e){
var normalized={
id:String(e.id||Date.now()),
date:normalizeDate(e.date),
title:String(e.title||""),
dapt:String(e.dapt||"")
};
console.log("ğŸ“… ì¼ì •:",normalized.date,normalized.title);
return normalized;
});

notices=data.notices||{};

console.log("âœ… ì´ ì´ë²¤íŠ¸ ìˆ˜:",events.length);
console.log("ğŸ“‹ ì „ì²´ ì¼ì •:",events);

setSyncStatus("â— ì™„ë£Œ ("+events.length+"ê±´)","#10b981");
render();
loading=false;
})
.catch(function(e){
console.error("âŒ ë¡œë“œ ì˜¤ë¥˜:",e);
setSyncStatus("â— ì˜¤ë¥˜","#ef4444");
loading=false;
});
}

function saveAndReload(action,data){
if(saving)return Promise.reject();
saving=true;
setSyncStatus("â— ì €ì¥ ì¤‘...","#f59e0b");
console.log("ğŸ’¾ ì €ì¥:",action,data);

return fetch(API,{
method:"POST",
body:JSON.stringify(Object.assign({action:action},data))
})
.then(function(r){return r.json();})
.then(function(result){
console.log("âœ… ì €ì¥ ì™„ë£Œ:",result);
if(!result.success)throw new Error(result.error||"ì‹¤íŒ¨");
setSyncStatus("â— ì €ì¥ë¨","#10b981");
saving=false;
setTimeout(function(){
console.log("ğŸ”„ ì„œë²„ ì¬ë¡œë“œ");
load();
},2000);
return result;
})
.catch(function(e){
console.error("âŒ ì €ì¥ ì‹¤íŒ¨:",e);
setSyncStatus("â— ì €ì¥ ì˜¤ë¥˜","#ef4444");
alert("ì €ì¥ ì‹¤íŒ¨: "+e.message);
saving=false;
throw e;
});
}

function render(){
var y=currentDate.getFullYear(),m=currentDate.getMonth()+1;
var modeText=viewMode=="week"?"ì£¼ê°„":viewMode=="month"?"ì›”ê°„":"í•™ì‚¬ë ¥";
document.getElementById("titleText").textContent=y+"ë…„ "+m+"ì›” "+modeText;

if(viewMode=="week")renderWeek();
else if(viewMode=="month")renderMonth();
else renderYear();
}

function renderWeek(){
console.log("ğŸ¨ ì£¼ê°„ ë Œë”ë§ ì‹œì‘");
console.log("ğŸ“… í˜„ì¬ ë‚ ì§œ:",currentDate);
console.log("ğŸ“‹ ì´ ì´ë²¤íŠ¸:",events.length);

var html="";
var start=new Date(currentDate);
start.setDate(start.getDate()-start.getDay());

for(var i=0;i<7;i++){
var d=new Date(start);
d.setDate(start.getDate()+i);
var ds=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");

console.log("ğŸ” ë‚ ì§œ í™•ì¸:",ds);

var evs=[];
for(var j=0;j<events.length;j++){
var eventDate=normalizeDate(events[j].date);
console.log("  ë¹„êµ:",eventDate,"vs",ds,"â†’",eventDate===ds);
if(eventDate===ds){
evs.push(events[j]);
}
}

console.log("  â†’ ë°œê²¬ëœ ì¼ì •:",evs.length+"ê±´");

var isWeekend=d.getDay()==0||d.getDay()==6;

html+="<div class='p-3 rounded-lg border mb-2 "+(isWeekend?"bg-red-50":"bg-white")+"'>";
html+="<div class='font-bold text-indigo-900'>"+d.getDate()+"ì¼ ("+dayNames[d.getDay()]+") <span class='text-xs text-gray-400'>"+ds+"</span></div>";

if(evs.length==0){
html+="<div class='text-gray-400 text-sm mt-1'>ì¼ì • ì—†ìŒ</div>";
}else{
evs.forEach(function(e){
html+="<div class='bg-indigo-50 p-2 rounded mt-1 text-sm border-l-4 border-indigo-600 flex justify-between items-center'>";
html+="<div><span class='font-bold'>"+e.title+"</span> <span class='text-indigo-600'>("+e.dapt+")</span></div>";
html+="<button onclick='deleteEvent(\""+e.id+"\")' class='text-red-600 font-bold text-lg hover:text-red-800'>âœ•</button>";
html+="</div>";
});
}
html+="</div>";
}

document.getElementById("viewport").innerHTML=html;
document.getElementById("notices").style.display="block";
renderNotices();

console.log("âœ… ì£¼ê°„ ë Œë”ë§ ì™„ë£Œ");
}

function renderMonth(){
var y=currentDate.getFullYear(),m=currentDate.getMonth();
var html="<div class='grid grid-cols-7 gap-1'>";

dayNames.forEach(function(dn){
html+="<div class='text-center font-bold text-sm p-2 bg-gray-100'>"+dn+"</div>";
});

var first=new Date(y,m,1).getDay();
var last=new Date(y,m+1,0).getDate();

for(var i=0;i<first;i++){
html+="<div class='bg-gray-50 p-2 min-h-24'></div>";
}

for(var d=1;d<=last;d++){
var ds=y+"-"+String(m+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
var evs=events.filter(function(e){return normalizeDate(e.date)===ds;});
var dayIdx=new Date(y,m,d).getDay();
var isWeekend=dayIdx==0||dayIdx==6;

html+="<div class='border p-2 min-h-24 cursor-pointer hover:bg-gray-50 "+(isWeekend?"bg-red-50":"bg-white")+"' onclick='showDetail(\""+ds+"\")'>";
html+="<div class='text-sm font-bold "+(dayIdx==0?"text-red-600":dayIdx==6?"text-blue-600":"text-gray-700")+"'>"+d+"</div>";

evs.forEach(function(e){
html+="<div class='text-xs bg-indigo-100 p-1 mt-1 rounded truncate'>"+e.title.substring(0,5)+"</div>";
});

html+="</div>";
}

html+="</div>";
document.getElementById("viewport").innerHTML=html;
document.getElementById("notices").style.display="none";
}

function renderYear(){
var y=currentDate.getFullYear();
var html="<div class='grid grid-cols-1 md:grid-cols-3 gap-4'>";

for(var m=0;m<12;m++){
html+="<div class='border rounded-lg p-3 bg-white'>";
html+="<div class='font-bold mb-2 text-center text-indigo-900'>"+(m+1)+"ì›”</div>";
html+="<div class='grid grid-cols-7 gap-1 text-xs'>";

["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(function(d){
html+="<div class='text-center font-bold text-gray-400'>"+d+"</div>";
});

var first=new Date(y,m,1).getDay();
var last=new Date(y,m+1,0).getDate();

for(var i=0;i<first;i++)html+="<div></div>";

for(var d=1;d<=last;d++){
var ds=y+"-"+String(m+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
var evs=events.filter(function(e){return normalizeDate(e.date)===ds;});
var hasEvent=evs.length>0;

html+="<div class='text-center p-1 rounded cursor-pointer hover:bg-gray-100 "+(hasEvent?"bg-indigo-100 font-bold":"")+"' onclick='showDetail(\""+ds+"\")'>"+d+"</div>";
}

html+="</div></div>";
}

html+="</div>";
document.getElementById("viewport").innerHTML=html;
document.getElementById("notices").style.display="none";
}

function renderNotices(){
var roles=[
{id:"principal",n:"ğŸ“ êµì¥"},
{id:"vp",n:"ğŸ‘” êµê°"},
{id:"admin",n:"ğŸ¢ í–‰ì •ì‹¤ì¥"},
{id:"d1",n:"ğŸ“˜ êµë¬´ë¶€"},
{id:"d2",n:"ğŸ“• ì—°êµ¬ë¶€"},
{id:"d3",n:"ğŸ“— í•™ìƒë¶€"},
{id:"d4",n:"ğŸ“™ ì°½ì˜ì¸ì„±ë¶€"},
{id:"grade",n:"ğŸ¯ í•™ë…„ì‹¤"}
];

var wk=getWeekKey();
var wn=notices[wk]||{};
var html="";

roles.forEach(function(r){
var val=wn[r.id]||"";
html+="<div class='mb-3'>";
html+="<div class='font-bold text-sm mb-1'>"+r.n+"</div>";
html+="<div class='flex gap-2'>";
html+="<input type='text' id='n_"+r.id+"' value='"+val.replace(/'/g,"&apos;")+"' class='flex-1 border p-2 rounded text-sm "+(val?"notice-green":"")+"' placeholder='ì…ë ¥ í›„ ë‹¤ë¥¸ ê³³ í´ë¦­' onblur='autoSaveNotice(\""+r.id+"\")'>";
html+="</div></div>";
});

document.getElementById("noticeList").innerHTML=html;
}

function autoSaveNotice(r){
var wk=getWeekKey();
var el=document.getElementById("n_"+r);
if(!el)return;

var val=el.value.trim();
var oldVal=(notices[wk]&&notices[wk][r])||"";

if(val==oldVal)return;

if(!notices[wk])notices[wk]={};
notices[wk][r]=val;

if(val)el.classList.add("notice-green");
else el.classList.remove("notice-green");

saveAndReload("saveNotice",{weekKey:wk,role:r,content:val});
}

function deleteEvent(id){
if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
console.log("ğŸ—‘ï¸ ì‚­ì œ:",id);
events=events.filter(function(e){return e.id!=id;});
render();
saveAndReload("deleteEvent",{id:id});
}

function showDetail(ds){
var evs=events.filter(function(e){return normalizeDate(e.date)===ds;});
var html="<h3 class='font-bold text-lg mb-4'>ğŸ“… "+ds+"</h3>";

if(evs.length==0){
html+="<p class='text-gray-400 text-center py-8'>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
}else{
evs.forEach(function(e){
html+="<div class='bg-gray-50 p-3 rounded mb-2 border-l-4 border-indigo-600'>";
html+="<div class='font-bold text-indigo-900'>"+e.title+"</div>";
html+="<div class='text-sm text-gray-600 mt-1'>ë‹´ë‹¹: "+e.dapt+"</div>";
html+="</div>";
});
}

document.getElementById("detailContent").innerHTML=html;
document.getElementById("detailModal").classList.add("show");
}

function getWeekKey(){
var d=new Date(currentDate);
var day=d.getDay();
d.setDate(d.getDate()-(day==0?6:day-1));
return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

document.getElementById("btnAdmin").onclick=function(){
document.getElementById("loginModal").classList.add("show");
};

document.getElementById("btnLogin").onclick=function(){
if(document.getElementById("adminId").value=="admin"&&document.getElementById("adminPw").value=="1234"){
isAdmin=true;
document.getElementById("adminBadge").style.display="block";
document.getElementById("loginModal").classList.remove("show");
}else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
};

document.getElementById("btnWeek").onclick=function(){viewMode="week";render();};
document.getElementById("btnMonth").onclick=function(){viewMode="month";render();};
document.getElementById("btnYear").onclick=function(){viewMode="year";render();};

document.getElementById("btnPrev").onclick=function(){
if(viewMode=="year")currentDate.setFullYear(currentDate.getFullYear()-1);
else if(viewMode=="month")currentDate.setMonth(currentDate.getMonth()-1);
else currentDate.setDate(currentDate.getDate()-7);
render();
};

document.getElementById("btnNext").onclick=function(){
if(viewMode=="year")currentDate.setFullYear(currentDate.getFullYear()+1);
else if(viewMode=="month")currentDate.setMonth(currentDate.getMonth()+1);
else currentDate.setDate(currentDate.getDate()+7);
render();
};

document.getElementById("btnSave").onclick=function(){
var d=document.getElementById("inDate").value;
var t=document.getElementById("inTitle").value;
var dept=document.getElementById("inDept").value;

if(!d||!t){alert("ë‚ ì§œì™€ ë‚´ìš© ì…ë ¥ í•„ìš”");return;}

var normalized=normalizeDate(d);
var newEvent={id:Date.now().toString(),date:normalized,title:t,dapt:dept};
console.log("ğŸ’¾ ì¼ì • ì¶”ê°€:",newEvent);

events.push(newEvent);
render();

document.getElementById("inDate").value="";
document.getElementById("inTitle").value="";

saveAndReload("addEvent",newEvent);
};

document.getElementById("closeDetail").onclick=function(){
document.getElementById("detailModal").classList.remove("show");
};

console.log("ğŸš€ êµ¬ë¡€ì¤‘ í•™ì‚¬ë ¥ ì‹œì‘");
console.log("ğŸ“ API:",API);
load();
setInterval(function(){if(!loading&&!saving)load();},30000);
</script>
</body>
</html>
