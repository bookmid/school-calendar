<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>êµ¬ë¡€ì¤‘ ì‹¤ì‹œê°„ í•™ì‚¬ë ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .notice-input.has-content { background-color: #e8f5e9; border-color: #66bb6a; font-weight: 700; color: #1b5e20; }
        .admin-badge { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 6px 12px; border-radius: 12px; font-size: 10px; font-weight: 900; z-index: 1000; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        @media (max-width: 768px) {
            body { font-size: 14px; }
        }
    </style>
</head>
<body class="p-3">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-indigo-900 p-4 rounded-2xl text-white shadow-lg">
            <h1 class="font-black">ğŸ« êµ¬ë¡€ì¤‘ í•™ì‚¬ë ¥</h1>
            <div class="flex gap-2">
                <button onclick="app.showLoginModal()" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ğŸ”</button>
                <button onclick="app.setView('weekly')" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ì£¼ê°„</button>
                <button onclick="app.setView('monthly')" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ì›”ê°„</button>
                <button onclick="app.setView('yearly')" class="text-xs bg-indigo-700 px-3 py-1.5 rounded-lg font-bold">ì—°ê°„</button>
            </div>
        </header>

        <section class="bg-white p-4 rounded-2xl shadow-sm border mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="date" id="inDate" class="border p-2 rounded-xl text-sm">
            <input type="text" id="inTitle" placeholder="í–‰ì‚¬ë‚´ìš©" class="border p-2 rounded-xl text-sm">
            <select id="inDept" class="border p-2 rounded-xl text-sm">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>ì°½ì˜</option><option>í–‰ì •</option>
            </select>
            <button onclick="app.saveEvent()" class="bg-indigo-600 text-white rounded-xl font-bold py-2">ì €ì¥</button>
        </section>

        <div class="flex justify-between items-center bg-white p-3 rounded-2xl border mb-4">
            <button onclick="app.move(-1)" class="text-indigo-600 font-bold px-4">â®</button>
            <h2 id="titleText" class="text-lg font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="app.move(1)" class="text-indigo-600 font-bold px-4">â¯</button>
        </div>

        <div id="viewPort"></div>
        <div id="weeklyNotices" style="display:none;"></div>

        <footer class="text-center py-8 text-slate-400 text-[10px]">Â© Choi Gwang-cheul, Gurye Middle School</footer>
    </div>

    <div id="adminBadge" class="admin-badge" style="display:none;">
        ğŸ” ê´€ë¦¬ì
        <button onclick="app.logout()" style="margin-left:8px; background:#dc2626; padding:2px 6px; border-radius:4px; font-size:9px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="syncIndicator" style="position: fixed; bottom: 20px; right: 20px; background: #4f46e5; color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 700; z-index: 1000;">
        <span id="syncText">â— ì´ˆê¸°í™”</span>
    </div>

    <div id="loginModal" class="modal">
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; position: relative;">
            <span onclick="app.closeModal('loginModal')" style="position: absolute; top: 12px; right: 12px; font-size: 24px; cursor: pointer;">&times;</span>
            <h3 style="font-size: 18px; font-weight: 900; margin-bottom: 16px;">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <input type="text" id="adminId" placeholder="ì•„ì´ë””" value="admin" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;">
            <button onclick="app.login()" style="width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">ë¡œê·¸ì¸</button>
            <div id="loginError" style="color:#ef4444; font-size:12px; margin-top:8px; display:none;"></div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; position: relative;">
            <span onclick="app.closeModal('eventModal')" style="position: absolute; top: 12px; right: 12px; font-size: 24px; cursor: pointer;">&times;</span>
            <div id="eventModalContent"></div>
        </div>
    </div>

    <script>
        var app = {
            API_URL: "''')
    f.write(api_url)
    f.write('''",
            events: [],
            notices: {},
            currentDate: new Date(),
            viewMode: 'weekly',
            isAdmin: false,
            isLoading: false,
            holidays: ['2026-01-01:ì‹ ì •','2026-02-16:ì„¤ë‚ ì—°íœ´','2026-02-17:ì„¤ë‚ ','2026-02-18:ì„¤ë‚ ì—°íœ´','2026-03-01:ì‚¼ì¼ì ˆ','2026-05-05:ì–´ë¦°ì´ë‚ ','2026-06-06:í˜„ì¶©ì¼','2026-08-15:ê´‘ë³µì ˆ','2026-09-25:ì¶”ì„','2026-10-03:ê°œì²œì ˆ','2026-10-09:í•œê¸€ë‚ ','2026-12-25:í¬ë¦¬ìŠ¤ë§ˆìŠ¤'],
            dayNames: ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],
            
            showLoginModal: function() { document.getElementById('loginModal').classList.add('active'); },
            closeModal: function(id) { document.getElementById(id).classList.remove('active'); },
            
            login: function() {
                var id = document.getElementById('adminId').value;
                var pw = document.getElementById('adminPw').value;
                if (id === 'admin' && pw === '1234') {
                    this.isAdmin = true;
                    document.getElementById('adminBadge').style.display = 'block';
                    this.closeModal('loginModal');
                    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ!');
                    this.render();
                } else {
                    document.getElementById('loginError').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                    document.getElementById('loginError').style.display = 'block';
                }
            },
            
            logout: function() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.isAdmin = false;
                    document.getElementById('adminBadge').style.display = 'none';
                    this.render();
                }
            },
            
            showEventModal: function(dateStr) {
                var dayEvents = this.events.filter(function(e) { return e.date === dateStr; });
                var date = new Date(dateStr);
                var html = '<h3 style="font-size:18px; font-weight:900; margin-bottom:16px;">' + (date.getMonth()+1) + 'ì›” ' + date.getDate() + 'ì¼</h3>';
                if (dayEvents.length === 0) {
                    html += '<p style="color:#94a3b8; padding:20px; text-align:center;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    for (var i = 0; i < dayEvents.length; i++) {
                        html += '<div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #6366f1;">';
                        html += '<div style="font-weight:700; color:#1e293b;">' + dayEvents[i].title + '</div>';
                        html += '<div style="font-size:12px; color:#64748b;">ë‹´ë‹¹: ' + dayEvents[i].dapt + '</div>';
                        html += '</div>';
                    }
                }
                document.getElementById('eventModalContent').innerHTML = html;
                document.getElementById('eventModal').classList.add('active');
            },
            
            setSyncStatus: function(text) {
                document.getElementById('syncText').textContent = text;
            },
            
            getWeekKey: function() {
                var d = new Date(this.currentDate);
                var day = d.getDay();
                var offset = day === 0 ? -6 : -(day - 1);
                d.setDate(d.getDate() + offset);
                return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            },
            
            loadFromServer: function() {
                var self = this;
                if (self.isLoading) return;
                self.isLoading = true;
                self.setSyncStatus('â— ë¡œë”©...');
                
                fetch(self.API_URL + '?action=load&t=' + Date.now())
                    .then(function(res) {
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        return res.json();
                    })
                    .then(function(data) {
                        console.log('âœ… ë°ì´í„°:', data);
                        self.events = data.events || [];
                        self.notices = data.notices || {};
                        self.setSyncStatus('â— ì™„ë£Œ');
                        self.render();
                    })
                    .catch(function(err) {
                        console.error('âŒ', err);
                        self.setSyncStatus('â— ì˜¤ë¥˜');
                    })
                    .finally(function() {
                        self.isLoading = false;
                    });
            },
            
            saveToServer: function(action, data) {
                var self = this;
                if (self.isLoading) return Promise.reject();
                self.isLoading = true;
                self.setSyncStatus('â— ì €ì¥...');
                
                return fetch(self.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({action: action, id: data.id, date: data.date, title: data.title, dapt: data.dapt, weekKey: data.weekKey, role: data.role, content: data.content})
                })
                .then(function(res) { return res.json(); })
                .then(function(result) {
                    console.log('âœ… ì €ì¥:', result);
                    setTimeout(function() {
                        self.loadFromServer();
                    }, 1000);
                    return result;
                })
                .catch(function(err) {
                    console.error('âŒ', err);
                    alert('ì €ì¥ ì‹¤íŒ¨');
                })
                .finally(function() {
                    self.isLoading = false;
                });
            },
            
            saveEvent: function() {
                var dateInput = document.getElementById('inDate').value;
                var title = document.getElementById('inTitle').value;
                var dapt = document.getElementById('inDept').value;
                if (!dateInput || !title) { alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                
                var newEvent = {id: Date.now().toString(), date: dateInput, title: title, dapt: dapt};
                this.events.push(newEvent);
                this.render();
                this.saveToServer('addEvent', newEvent);
                document.getElementById('inDate').value = '';
                document.getElementById('inTitle').value = '';
            },
            
            deleteEvent: function(id) {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                var self = this;
                self.events = self.events.filter(function(e) { return e.id !== id; });
                self.render();
                self.saveToServer('deleteEvent', {id: id});
            },
            
            toggleHoliday: function(dateStr) {
                if (!this.isAdmin) { this.showEventModal(dateStr); return; }
                var self = this;
                var existing = self.events.find(function(e) { return e.date === dateStr && e.title === 'íœ´ì—…ì¼'; });
                if (existing) {
                    if (confirm('íœ´ì—…ì¼ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) self.deleteEvent(existing.id);
                } else {
                    if (confirm('íœ´ì—…ì¼ë¡œ ì§€ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        var newEvent = {id: Date.now().toString(), date: dateStr, title: 'íœ´ì—…ì¼', dapt: 'í•™ì‚¬'};
                        self.events.push(newEvent);
                        self.render();
                        self.saveToServer('addEvent', newEvent);
                    }
                }
            },
            
            handleNoticeInput: function(role) {
                var weekKey = this.getWeekKey();
                var input = document.getElementById('notice_' + role);
                if (!input) return;
                var value = input.value;
                if (!this.notices[weekKey]) this.notices[weekKey] = {};
                this.notices[weekKey][role] = value;
                input.classList.remove('has-content');
                if (value.trim()) input.classList.add('has-content');
            },
            
            saveNoticeBtn: function(role) {
                var weekKey = this.getWeekKey();
                var input = document.getElementById('notice_' + role);
                if (!input) return;
                var value = input.value.trim();
                if (!this.notices[weekKey]) this.notices[weekKey] = {};
                this.notices[weekKey][role] = value;
                this.saveToServer('saveNotice', {weekKey: weekKey, role: role, content: value});
                if (value) input.classList.add('has-content');
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            },
            
            deleteNoticeBtn: function(role) {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                var weekKey = this.getWeekKey();
                var input = document.getElementById('notice_' + role);
                if (!input) return;
                if (this.notices[weekKey]) delete this.notices[weekKey][role];
                input.value = '';
                input.classList.remove('has-content');
                this.saveToServer('saveNotice', {weekKey: weekKey, role: role, content: ''});
            },
            
            move: function(dir) {
                if (this.viewMode === 'yearly') {
                    this.currentDate.setFullYear(this.currentDate.getFullYear() + dir);
                } else if (this.viewMode === 'monthly') {
                    this.currentDate.setMonth(this.currentDate.getMonth() + dir);
                } else {
                    this.currentDate.setDate(this.currentDate.getDate() + (dir * 7));
                }
                this.render();
            },
            
            setView: function(mode) {
                this.viewMode = mode;
                this.render();
            },
            
            renderWeekly: function() {
                var self = this;
                var start = new Date(self.currentDate);
                start.setDate(start.getDate() - start.getDay());
                var html = '<div style="display:flex; flex-direction:column; gap:8px;">';
                
                for (var i = 0; i < 7; i++) {
                    var d = new Date(start);
                    d.setDate(start.getDate() + i);
                    var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                    var dayEvents = self.events.filter(function(e) { return e.date === dateStr; });
                    var dayName = self.dayNames[d.getDay()];
                    var isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    
                    html += '<div style="background:' + (isWeekend ? '#fef2f2' : 'white') + '; padding:16px; border-radius:12px; border:1px solid #e2e8f0;">';
                    html += '<div style="font-weight:900; color:#3730a3; margin-bottom:8px;">' + d.getDate() + 'ì¼ (' + dayName + ')</div>';
                    
                    if (dayEvents.length === 0) {
                        html += '<div style="color:#94a3b8; font-size:12px;">ì¼ì • ì—†ìŒ</div>';
                    } else {
                        for (var j = 0; j < dayEvents.length; j++) {
                            html += '<div style="background:#f1f5f9; padding:8px; border-radius:6px; margin-bottom:4px; border-left:3px solid #4f46e5; display:flex; justify-content:space-between; align-items:center;">';
                            html += '<span style="font-weight:700; font-size:12px;">' + dayEvents[j].title + ' <span style="color:#6366f1;">(' + dayEvents[j].dapt + ')</span></span>';
                            html += '<span onclick="app.deleteEvent(\\'+ dayEvents[j].id +'\\')" style="color:#ef4444; cursor:pointer; font-weight:700;">âœ•</span>';
                            html += '</div>';
                        }
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
                
                // ì•ˆë‚´ì‚¬í•­
                var weekKey = self.getWeekKey();
                var monday = new Date(self.currentDate);
                monday.setDate(monday.getDate() - (monday.getDay() || 7) + 1);
                var weekNotices = self.notices[weekKey] || {};
                var roles = [
                    {id: 'principal', label: 'ğŸ“ êµì¥'},
                    {id: 'vprincipal', label: 'ğŸ‘” êµê°'},
                    {id: 'admin', label: 'ğŸ¢ í–‰ì •ì‹¤ì¥'},
                    {id: 'dept1', label: 'ğŸ“˜ êµë¬´ë¶€'},
                    {id: 'dept2', label: 'ğŸ“• ì—°êµ¬ë¶€'},
                    {id: 'dept3', label: 'ğŸ“— í•™ìƒë¶€'},
                    {id: 'dept4', label: 'ğŸ“™ ì°½ì˜ì¸ì„±ë¶€'},
                    {id: 'grade', label: 'ğŸ¯ í•™ë…„ì‹¤'}
                ];
                
                html += '<div style="background:white; padding:16px; border-radius:12px; margin-top:16px; border:2px solid #e2e8f0;">';
                html += '<h3 style="font-weight:900; color:#3730a3; margin-bottom:16px;">ğŸ“¢ ì£¼ê°„ ì•ˆë‚´ì‚¬í•­</h3>';
                
                for (var k = 0; k < roles.length; k++) {
                    var role = roles[k];
                    var value = weekNotices[role.id] || '';
                    var hasContent = value.trim() ? 'has-content' : '';
                    html += '<div style="margin-bottom:12px;">';
                    html += '<div style="font-weight:900; color:#4f46e5; font-size:12px; margin-bottom:4px;">' + role.label + '</div>';
                    html += '<div style="display:flex; gap:8px; flex-wrap:wrap;">';
                    html += '<input type="text" id="notice_' + role.id + '" class="notice-input ' + hasContent + '" value="' + value + '" oninput="app.handleNoticeInput(\\'+ role.id +'\\')" placeholder="' + role.label + ' ì•ˆë‚´ì‚¬í•­" style="flex:1; min-width:200px; border:1px solid #e2e8f0; border-radius:8px; padding:8px; font-size:12px;">';
                    html += '<button onclick="app.saveNoticeBtn(\\'+ role.id +'\\')" style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:6px; font-size:11px; font-weight:700; cursor:pointer;">ì €ì¥</button>';
                    html += '<button onclick="app.deleteNoticeBtn(\\'+ role.id +'\\')" style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; font-size:11px; font-weight:700; cursor:pointer;">ì‚­ì œ</button>';
                    html += '</div></div>';
                }
                
                html += '</div>';
                
                document.getElementById('weeklyNotices').innerHTML = '';
                document.getElementById('weeklyNotices').style.display = 'none';
                return html;
            },
            
            renderMonthly: function() {
                var self = this;
                var year = self.currentDate.getFullYear();
                var month = self.currentDate.getMonth();
                var html = '<div style="display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e2e8f0; border-radius:12px; overflow:hidden;">';
                
                ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(function(w) {
                    html += '<div style="background:#f8fafc; padding:8px; text-align:center; font-size:11px; font-weight:700; color:#64748b;">' + w + '</div>';
                });
                
                var first = new Date(year, month, 1).getDay();
                var last = new Date(year, month + 1, 0).getDate();
                
                for (var i = 0; i < first; i++) {
                    html += '<div style="background:#f8fafc; min-height:100px;"></div>';
                }
                
                for (var d = 1; d <= last; d++) {
                    var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                    var dayIdx = new Date(year, month, d).getDay();
                    var dayEvents = self.events.filter(function(e) { return e.date === dateStr; });
                    var isWeekend = dayIdx === 0 || dayIdx === 6;
                    
                    html += '<div onclick="app.toggleHoliday(\\'+ dateStr +'\\')" style="background:' + (isWeekend ? '#fef2f2' : 'white') + '; padding:6px; min-height:100px; cursor:pointer; position:relative;">';
                    html += '<div style="font-size:11px; font-weight:900; color:' + (dayIdx === 0 ? '#ef4444' : (dayIdx === 6 ? '#3b82f6' : '#64748b')) + ';">' + d + '</div>';
                    
                    for (var j = 0; j < Math.min(dayEvents.length, 3); j++) {
                        html += '<div onclick="event.stopPropagation(); app.showEventModal(\\'+ dateStr +'\\')" style="font-size:9px; padding:2px 4px; margin-top:2px; background:#f1f5f9; border-radius:4px; border-left:2px solid #6366f1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer;">';
                        html += dayEvents[j].title.substring(0, 5);
                        html += '</div>';
                    }
                    
                    if (dayEvents.length > 3) {
                        html += '<div style="font-size:9px; color:#6366f1; margin-top:2px;">+' + (dayEvents.length - 3) + '</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
                return html;
            },
            
            renderYearly: function() {
                return '<div style="text-center; padding:40px; color:#94a3b8;">ì—°ê°„ ë·° ì¤€ë¹„ ì¤‘...</div>';
            },
            
            render: function() {
                var year = this.currentDate.getFullYear();
                var month = this.currentDate.getMonth() + 1;
                var viewPort = document.getElementById('viewPort');
                var titleText = document.getElementById('titleText');
                
                if (this.viewMode === 'yearly') {
                    titleText.textContent = year + 'ë…„ ì „ì²´';
                    viewPort.innerHTML = this.renderYearly();
                } else if (this.viewMode === 'monthly') {
                    titleText.textContent = year + 'ë…„ ' + month + 'ì›”';
                    viewPort.innerHTML = this.renderMonthly();
                } else {
                    titleText.textContent = year + 'ë…„ ' + month + 'ì›” ì£¼ê°„';
                    viewPort.innerHTML = this.renderWeekly();
                }
            },
            
            init: function() {
                console.log('ğŸš€ [ì‹œì‘]');
                console.log('ğŸ“ API URL:', this.API_URL);
                this.loadFromServer();
                var self = this;
                setInterval(function() {
                    if (!self.isLoading) self.loadFromServer();
                }, 15000);
            }
        };
        
        window.addEventListener('DOMContentLoaded', function() {
            app.init();
        });
    </script>
</body>
</html>
