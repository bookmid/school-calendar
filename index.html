<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¡€ì¤‘ ì‹¤ì‹œê°„ í•™ì‚¬ë ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .day-cell { min-height: 100px; background-color: white; padding: 4px; display: flex; flex-direction: column; }
        .event-badge { font-size: 11px; padding: 2px 6px; margin-top: 2px; border-radius: 4px; background-color: #eff6ff; border-left: 3px solid #3b82f6; color: #1e3a8a; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .del-btn { color: #ef4444; margin-left: 5px; cursor: pointer; font-size: 14px; }
        .bg-sun { background-color: #fff1f2; } .bg-sat { background-color: #f0f9ff; }
    </style>
    <script>
        // 1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
        const API_URL = 'https://script.google.com/macros/s/AKfycbwftofBuDxYKEkCF-5mZ4Ss-bi6VJVstCAR6RhKasmXeM6oF7ZuCwlcbpU7GzivVMyH/exec';
        let events = [];
        let viewDate = new Date();
        let currentView = 'monthly';

        // 2. í•µì‹¬ í•¨ìˆ˜ ì •ì˜ (ë¸Œë¼ìš°ì €ê°€ ì¦‰ì‹œ ì¸ì‹í•˜ë„ë¡ ìµœìƒë‹¨ ë°°ì¹˜)
        window.toKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        window.render = function() {
            const port = document.getElementById('viewPort');
            const title = document.getElementById('displayTitle');
            if(!port || !title) return;

            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            
            if (currentView === 'monthly') {
                title.innerText = `${y}ë…„ ${m + 1}ì›”`;
                let html = '<div class="calendar-grid">';
                ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => html += `<div class="bg-slate-50 p-2 text-center text-xs font-bold">${d}</div>`);
                
                const firstDay = new Date(y, m, 1).getDay();
                const lastDate = new Date(y, m + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) html += '<div class="day-cell bg-slate-50/50"></div>';
                for (let d = 1; d <= lastDate; d++) {
                    const dateObj = new Date(y, m, d);
                    const key = window.toKey(dateObj);
                    const isSun = dateObj.getDay() === 0;
                    html += `<div class="day-cell ${isSun ? 'bg-sun' : ''}">
                        <div class="text-[10px] font-bold ${isSun ? 'text-red-500' : 'text-slate-400'}">${d}</div>
                        <div class="flex-1 overflow-y-auto">
                            ${events.filter(e => e.date === key).map(e => `
                                <div class="event-badge">
                                    <span>${e.title} (${e.dapt})</span>
                                    <span class="del-btn" onclick="window.handleDelete('${e.id}')">Ã—</span>
                                </div>`).join('')}
                        </div></div>`;
                }
                port.innerHTML = html + '</div>';
            } else {
                // ì£¼ê°„ ë³´ê¸° ë¡œì§
                const start = new Date(viewDate);
                start.setDate(viewDate.getDate() - viewDate.getDay());
                title.innerText = `${y}ë…„ ${m + 1}ì›” ì£¼ê°„`;
                let html = '<div class="flex flex-col gap-2">';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    const key = window.toKey(d);
                    html += `<div class="p-4 bg-white rounded-lg shadow-sm border flex items-center">
                        <div class="w-12 font-black text-indigo-600">${d.getDate()}ì¼</div>
                        <div class="flex-1">${events.filter(e => e.date === key).map(e => `<div class="event-badge py-1 mb-1"><span>${e.title} (${e.dapt})</span><span class="del-btn" onclick="window.handleDelete('${e.id}')">Ã—</span></div>`).join('')}</div>
                    </div>`;
                }
                port.innerHTML = html + '</div>';
            }
        };

        window.shiftTime = (n) => {
            if (currentView === 'monthly') viewDate.setMonth(viewDate.getMonth() + n);
            else viewDate.setDate(viewDate.getDate() + (n * 7));
            window.render();
        };

        window.changeView = (v) => { currentView = v; window.render(); };

        window.handleSave = async () => {
            const date = document.getElementById('inDate').value;
            const title = document.getElementById('inTitle').value;
            const dapt = document.getElementById('inDept').value;
            if (!date || !title) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            const newItem = { id: String(Date.now()), date, title, dapt };
            events.push(newItem); window.render();
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', ...newItem }) });
        };

        window.handleDelete = async (id) => {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            events = events.filter(e => e.id !== id); window.render();
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
        };

        async function sync() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                events = data.map(e => ({ ...e, date: String(e.date).substring(0, 10) }));
                window.render();
            } catch (e) { console.error("Sync Error", e); }
        }

        window.onload = () => { sync(); setInterval(sync, 15000); };
    </script>
</head>
<body class="p-2 md:p-4">
    <header class="max-w-4xl mx-auto bg-indigo-900 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-lg">
        <h1 class="font-black text-lg">ğŸ« êµ¬ë¡€ì¤‘ ì‹¤ì‹œê°„ í•™ì‚¬ë ¥</h1>
        <div class="flex gap-2">
            <button onclick="window.changeView('monthly')" class="text-xs bg-indigo-700 px-3 py-1 rounded font-bold">ì›”ê°„</button>
            <button onclick="window.changeView('weekly')" class="text-xs bg-indigo-700 px-3 py-1 rounded font-bold">ì£¼ê°„</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto bg-white p-4 shadow-md">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6 bg-slate-50 p-3 rounded-xl border border-slate-200">
            <input type="date" id="inDate" class="border p-2 rounded-lg text-sm">
            <input type="text" id="inTitle" placeholder="í–‰ì‚¬ëª…" class="border p-2 rounded-lg text-sm">
            <select id="inDept" class="border p-2 rounded-lg text-sm">
                <option>êµë¬´</option><option>ì—°êµ¬</option><option>í•™ìƒ</option><option>í•™ë…„</option><option>í–‰ì •</option>
            </select>
            <button onclick="window.handleSave()" class="bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">ì €ì¥í•˜ê¸°</button>
        </div>

        <div class="flex justify-between items-center mb-4">
            <button onclick="window.shiftTime(-1)" class="text-2xl font-bold text-indigo-600 px-4">â®</button>
            <h2 id="displayTitle" class="text-xl font-black text-slate-700">ë¡œë”© ì¤‘...</h2>
            <button onclick="window.shiftTime(1)" class="text-2xl font-bold text-indigo-600 px-4">â¯</button>
        </div>

        <div id="viewPort"></div>
    </main>

    <footer class="max-w-4xl mx-auto text-center py-6 text-slate-400 text-[10px]">
        Developed by <span class="font-bold text-slate-600">Choi Gwang-cheul</span>, Gurye Middle School
    </footer>
</body>
</html>
